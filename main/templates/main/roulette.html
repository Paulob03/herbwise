{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Roulette Odds Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'main/roulette.css' %}">
</head>
<body>
    <div class="container">
        <h1>Roulette Analyzer</h1>
        <div class="input-section">
            <input type="number" id="numberInput" min="0" max="36" placeholder="Number (0-36)">
            <button id="addButton">Add</button>
            <button id="undoButton">Undo</button>
            <button id="clearButton">Clear</button>
        </div>

        <div class="history">
            <h3>Recent Numbers</h3>
            <div class="grid" id="historyGrid"></div>
        </div>

        <div class="main-grid">
            <div class="number-grid-container">
                <div class="stat-card">
                    <h3>Numbers</h3>
                    <div class="roulette-grid" id="numberGrid"></div>
                </div>
                <!-- Add history grid here if needed -->
            </div>

            <div class="stats-section">

                <!-- Add High/Low section -->
                <div class="stat-card">
                    <h3>High/Low</h3>
                    <table>
                        <tr><th>Range</th><th>Count</th><th>%</th></tr>
                        <tbody id="highLowStats"></tbody>
                    </table>
                </div>

                <div class="stat-card">
                    <h3>Even/Odd</h3>
                    <table>
                        <tr><th>Type</th><th>Count</th><th>%</th></tr>
                        <tbody id="parityStats"></tbody>
                    </table>
                </div>

                <div class="stat-card">
                    <h3>Red/Black</h3>
                    <table>
                        <tr><th>Color</th><th>Count</th><th>%</th></tr>
                        <tbody id="colorStats"></tbody>
                    </table>
                </div>

                <!-- Split rows and columns into separate sections -->
                <div class="stat-card scrollable separated-section">
                    <h3>Rows</h3>
                    <table>
                        <tr><th>Row</th><th>Count</th><th>%</th></tr>
                        <tbody id="rowStats"></tbody>
                    </table>
                </div>

                <div class="stat-card scrollable">
                    <h3>Columns</h3>
                    <table>
                        <tr><th>Column</th><th>Count</th><th>%</th></tr>
                        <tbody id="columnStats"></tbody>
                    </table>
                </div>

                <div class="suggestions-section">
                    <div class="stat-card">
                        <h3>Probabilistic Numbers</h3>
                        <div class="suggested-numbers" id="suggestedNumbers"></div>
                        <div class="suggested-row-column">
                            <div>Probabilistic Rows: <span id="suggestedRow">None</span></div>
                            <div>Probabilistic Columns: <span id="suggestedColumn">None</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const redNumbers = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
        let stats = {
            numbers: {},
            red: 0,
            black: 0,
            odd: 0,
            even: 0,
            high: 0,    // Added high/low tracking
            low: 0,     // Added high/low tracking
            rows: Array(12).fill(0),
            columns: Array(3).fill(0),
            history: []
        };

        function getNumberColor(num) {
            num = parseInt(num);
            if (num === 0) return 'var(--green)';
            return redNumbers.has(num) ? 'var(--red)' : 'var(--black)';
        }

        function getRow(num) {
            return num === 0 ? -1 : Math.floor((num - 1) / 3);
        }

        function getColumn(num) {
            return num === 0 ? -1 : (num - 1) % 3;
        }

        function getStreet(num) {
            return num === 0 ? -1 : Math.floor((num - 1) / 3);
        }

        function updateStats(num) {
            stats.numbers[num] = (stats.numbers[num] || 0) + 1;
            
            if (num !== 0) {
                num % 2 === 0 ? stats.even++ : stats.odd++;
                redNumbers.has(num) ? stats.red++ : stats.black++;
                
                // Update high/low
                if (num <= 18) stats.low++;
                else stats.high++;

                const row = Math.floor((num - 1) / 3);
                stats.rows[row]++;
                
                const col = (num - 1) % 3;
                stats.columns[col]++;
            }

            stats.history.push(num);
        }

        function renderRowStats() {
            const total = stats.history.length - (stats.numbers[0] || 0);
            return stats.rows.map((count, i) => {
                const start = i * 3 + 1;
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : '0.0';
                return `
                    <tr ${count < total/12 ? 'class="highlight"' : ''}>
                        <td>Row ${start}-${start+2}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        function calculateSuggestedNumbers() {
            const numbers = Array.from({ length: 37 }, (_, i) => i); // 0-36
            const counts = numbers.map(num => stats.numbers[num] || 0);
            const minCount = Math.min(...counts.filter(c => c !== undefined));
            let candidates = numbers.filter(num => counts[num] === minCount);
        
            // Filter by red/black
            const totalNonZeroColor = stats.red + stats.black;
            if (totalNonZeroColor > 0) {
                const redPercent = (stats.red / totalNonZeroColor) * 100;
                const threshold = 5;
                if (Math.abs(redPercent - 50) >= threshold) {
                    if (redPercent > 50) {
                        candidates = candidates.filter(num => num === 0 || !redNumbers.has(num));
                    } else {
                        candidates = candidates.filter(num => num === 0 || redNumbers.has(num));
                    }
                }
            }
        
            // Filter by high/low
            const totalNonZeroHL = stats.high + stats.low;
            if (totalNonZeroHL > 0) {
                const highPercent = (stats.high / totalNonZeroHL) * 100;
                const threshold = 5;
                if (Math.abs(highPercent - 50) >= threshold) {
                    if (highPercent > 50) {
                        candidates = candidates.filter(num => num === 0 || num <= 18);
                    } else {
                        candidates = candidates.filter(num => num === 0 || num >= 19);
                    }
                }
            }
        
            // Filter by even/odd
            const totalNonZeroEO = stats.even + stats.odd;
            if (totalNonZeroEO > 0) {
                const evenPercent = (stats.even / totalNonZeroEO) * 100;
                const threshold = 5;
                if (Math.abs(evenPercent - 50) >= threshold) {
                    if (evenPercent > 50) {
                        candidates = candidates.filter(num => num === 0 || num % 2 !== 0);
                    } else {
                        candidates = candidates.filter(num => num === 0 || num % 2 === 0);
                    }
                }
            }
            

            
    
            
        
            // Determine row suggestions
            const rowGroups = Array(12).fill().map((_,i) => []);
            candidates.forEach(num => {
                if (num === 0) return;
                const row = getRow(num);
                if (row !== -1) rowGroups[row].push(num);
            });

            // Sort rows by candidate count descending
            const sortedRows = rowGroups
                .map((nums, index) => ({ row: index+1, count: nums.length }))
                .sort((a,b) => b.count - a.count || a.row - b.row); // Tiebreaker: lower row first

                    // Get rows with max count (handle ties)
                    const maxRowCount = sortedRows[0]?.count || 0;
                    const suggestedRows = sortedRows
                        .filter(r => r.count === maxRowCount && r.count > 0)
                        .map(r => `Row ${(r.row-1)*3+1}-${r.row*3}`);

                    // Determine column suggestions (same logic)
                    const colGroups = Array(3).fill().map((_,i) => []);
                    candidates.forEach(num => {
                        if (num === 0) return;
                        const col = getColumn(num);
                        if (col !== -1) colGroups[col].push(num);
                    });

                    const sortedCols = colGroups
                        .map((nums, index) => ({ col: index+1, count: nums.length }))
                        .sort((a,b) => b.count - a.count || a.col - b.col);

                    const maxColCount = sortedCols[0]?.count || 0;
                    const suggestedCols = sortedCols
                        .filter(c => c.count === maxColCount && c.count > 0)
                        .map(c => `Column ${c.col}`);

                    
                    return {
                        numbers: candidates,
                        rows: suggestedRows,
                        columns: suggestedCols
                    };
        }

        function updateDisplay() {

            const suggested = calculateSuggestedNumbers();
            const suggestedNumbersDiv = document.getElementById('suggestedNumbers');
            
            // Modified section for suggested numbers display
            
                suggestedNumbersDiv.innerHTML = suggested.numbers.map(num => `
                    <div class="number-item" style="background:${getNumberColor(num)}">
                        ${num}
                    </div>
                `).join('');
            

            document.getElementById('suggestedRow').innerHTML = suggested.rows.length > 0
                ? suggested.rows.map(r => `<span class="suggestion-item">${r}</span>`).join(', ')
                : '<span class="no-suggestion">None</span>';

            document.getElementById('suggestedColumn').innerHTML = suggested.columns.length > 0
                ? suggested.columns.map(c => `<span class="suggestion-item">${c}</span>`).join(', ')
                : '<span class="no-suggestion">None</span>';


            // History grid
            document.getElementById('historyGrid').innerHTML = 
                stats.history.slice(-25).reverse().map(num => `
                    <div class="number-item" style="background:${getNumberColor(num)}">
                        ${num}
                    </div>
                `).join('');

            // Number grid
           
                const numberGrid = document.getElementById('numberGrid');
                const numbers = [];
                
                // Add zero first
                numbers.push(`
                    <div class="number-cell zero-cell">
                        <div>0</div>
                        <div class="count">${stats.numbers[0] || ''}</div>
                    </div>
                `);
    
                // Add numbers 1-36 in rows of 3
                for(let i = 1; i <= 36; i++) {
                    numbers.push(`
                        <div class="number-cell" 
                             style="background:${getNumberColor(i)}">
                            <div>${i}</div>
                            <div class="count">${stats.numbers[i] || ''}</div>
                        </div>
                    `);
                }
    
                numberGrid.innerHTML = numbers.join('');

            // Stats tables
            const total = stats.history.length;
            const spinsWithoutZero = total - (stats.numbers[0] || 0);

            // Row Stats
            const totalNonZero = stats.history.length - (stats.numbers[0] || 0);
            document.getElementById('rowStats').innerHTML = stats.rows.map((count, i) => {
                const percentage = totalNonZero > 0 ? (count / totalNonZero * 100).toFixed(1) : '0.0';
                return `
                    <tr ${count < totalNonZero/12 ? 'class="highlight"' : ''}>
                        <td>Row ${i+1} (${i*3+1}-${i*3+3})</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');

            // Column Stats
            document.getElementById('columnStats').innerHTML = stats.columns.map((count, i) => {
                const percentage = totalNonZero > 0 ? (count / totalNonZero * 100).toFixed(1) : '0.0';
                return `
                    <tr ${count < totalNonZero/3 ? 'class="highlight"' : ''}>
                        <td>Column ${i+1}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');

            // High/Low Stats
            const highLowTotal = stats.high + stats.low;
            document.getElementById('highLowStats').innerHTML = `
                <tr ${stats.low < stats.high ? 'class="highlight"' : ''}>
                    <td>Low (1-18)</td>
                    <td>${stats.low}</td>
                    <td>${highLowTotal > 0 ? (stats.low / highLowTotal * 100).toFixed(1) : '0.0'}%</td>
                </tr>
                <tr ${stats.high < stats.low ? 'class="highlight"' : ''}>
                    <td>High (19-36)</td>
                    <td>${stats.high}</td>
                    <td>${highLowTotal > 0 ? (stats.high / highLowTotal * 100).toFixed(1) : '0.0'}%</td>
                </tr>
            `;

            // Parity Stats
            document.getElementById('parityStats').innerHTML = `
                <tr ${stats.even < stats.odd ? 'class="highlight"' : ''}>
                    <td>Even</td>
                    <td>${stats.even}</td>
                    <td>${((stats.even / (stats.even + stats.odd)) * 100 || 0).toFixed(1)}%</td>
                </tr>
                <tr ${stats.odd < stats.even ? 'class="highlight"' : ''}>
                    <td>Odd</td>
                    <td>${stats.odd}</td>
                    <td>${((stats.odd / (stats.even + stats.odd)) * 100 || 0).toFixed(1)}%</td>
                </tr>
            `;

            // Color Stats
            document.getElementById('colorStats').innerHTML = `
                <tr ${stats.red < stats.black ? 'class="highlight"' : ''}>
                    <td>Red</td>
                    <td>${stats.red}</td>
                    <td>${((stats.red / spinsWithoutZero) * 100 || 0).toFixed(1)}%</td>
                </tr>
                <tr ${stats.black < stats.red ? 'class="highlight"' : ''}>
                    <td>Black</td>
                    <td>${stats.black}</td>
                    <td>${((stats.black / spinsWithoutZero) * 100 || 0).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>Green</td>
                    <td>${stats.numbers[0] || 0}</td>
                    <td>${((stats.numbers[0] / total) * 100 || 0).toFixed(1)}%</td>
                </tr>
            `;

            // Pair/Street Stats
            document.getElementById('pairStats').innerHTML = 
                Object.entries(stats.pairs)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([pair, count]) => `
                        <tr>
                            <td>Pair ${pair}</td>
                            <td>${count}</td>
                            <td>${((count / total) * 100 || 0).toFixed(1)}%</td>
                        </tr>
                    `).join('') ||
                '<tr><td colspan="3">No pairs yet</td></tr>';
                
        }

        document.getElementById('addButton').addEventListener('click', () => {
            const input = document.getElementById('numberInput');
            const num = parseInt(input.value);
            
            if (num >= 0 && num <= 36) {
                updateStats(num);
                updateDisplay();
                input.value = '';
            }
        });

        document.getElementById('clearButton').addEventListener('click', () => {
            stats = {
                numbers: {},
                red: 0,
                black: 0,
                odd: 0,
                even: 0,
                high: 0,
                low: 0,
                rows: Array(12).fill(0),
                columns: Array(3).fill(0),
                history: []
            };
            updateDisplay();
        });

        function undoLast() {
            if (stats.history.length === 0) return;
            
            const lastNumber = stats.history.pop();
            
            // Decrement counts
            if (lastNumber === 0) {
                stats.numbers[0]--;
                if (stats.numbers[0] === 0) delete stats.numbers[0];
            } else {
                stats.numbers[lastNumber]--;
                if (stats.numbers[lastNumber] === 0) delete stats.numbers[lastNumber];
                
                // Update other stats
                if (lastNumber % 2 === 0) stats.even--;
                else stats.odd--;
                
                if (redNumbers.has(lastNumber)) stats.red--;
                else stats.black--;
                
                if (lastNumber <= 18) stats.low--;
                else stats.high--;
                
                const row = Math.floor((lastNumber - 1) / 3);
                stats.rows[row]--;
                
                const col = (lastNumber - 1) % 3;
                stats.columns[col]--;

                
            }
            
            updateDisplay();
        }
        
        // Add event listener for undo button
        document.getElementById('undoButton').addEventListener('click', undoLast);

        updateDisplay();
    </script>
</body>
</html>